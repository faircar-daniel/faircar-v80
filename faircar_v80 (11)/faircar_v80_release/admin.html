<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FairCar — Admin catálogo</title>
  <link rel="stylesheet" href="assets/styles.css" />

  <link rel="icon" href="assets/favicon/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="48x48" href="assets/favicon/favicon-48x48.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png" />
  <meta name="theme-color" content="#0b1220" />
  <style>
    .admin-grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:960px){.admin-grid{grid-template-columns: 320px 1fr}}
    .admin-row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .admin-row .field{flex:1;min-width:180px}
    .admin-list{max-height: 320px;overflow:auto;border:1px solid rgba(148,163,184,.25);border-radius:12px;padding:10px}
    .pill2{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:6px 10px}
    .muted{opacity:.85}
    .danger{border-color: rgba(239,68,68,.35)}
  </style>
</head>
<body>
  <header class="topbar">
    
    <a class="brand" href="index.html" style="text-decoration:none;color:inherit">
      <img class="brand-logo-img" src="assets/brand/faircar_logo-night.png"
           srcset="assets/brand/faircar_logo-night.png 1x, assets/brand/faircar_logo-night@2x.png 2x"
           data-brand-logo="1"
           alt="FairCar" />
    </a>

    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
    <div class="theme-switch" aria-label="Cambiar colores de la página">
      <span class="theme-label">Colores</span>
      <div class="theme-dots">
        <button class="theme-dot" type="button" data-theme-pick="night" aria-label="Modo noche"></button>
        <button class="theme-dot" type="button" data-theme-pick="day" aria-label="Modo día"></button>
        <button class="theme-dot" type="button" data-theme-pick="ocean" aria-label="Modo océano"></button>
      </div>
    </div>
    <a class="btn ghost" href="tests.html">Tests</a>
    <div class="pill2 muted" id="adminStatus">Catálogo cargado</div>
  </div>
  </header>

  <main class="container">
    <section class="card" style="padding:18px">
      <div class="section-title">Gestión rápida de marcas, modelos y versiones</div>
      <div class="small muted" style="margin-top:6px">
        Esto no toca <b>carDatabase-v3.js</b>. Los cambios se guardan como un <b>patch</b>.
        Puedes trabajar rápido (local) y luego <b>exportar</b> el JSON para dejarlo permanente en Netlify.
      </div>

      <div class="admin-row" style="margin-top:12px">
        <button class="btn" id="btnExport" type="button">Exportar patch (JSON)</button>
        <label class="btn ghost" for="fileImport" style="cursor:pointer">Importar patch</label>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
        <button class="btn ghost danger" id="btnResetLocal" type="button">Borrar cambios locales</button>
      </div>
      <div class="hint" style="margin-top:10px">
        <b>Para hacerlo permanente:</b> sube el JSON exportado a <code>assets/faircar_db_patch.json</code> y redeploy en Netlify.
      </div>
    </section>

    <div class="admin-grid" style="margin-top:14px">
      <section class="card" style="padding:18px">
        <div class="section-title">Selección</div>

        <div class="field" style="margin-top:10px">
          <label>Marca</label>
          <div class="admin-row">
            <input id="brandSearch" class="input" placeholder="Buscar marca…" />
            <button class="btn" id="btnAddBrand" type="button">Añadir</button>
            <button class="btn ghost danger" id="btnDelBrand" type="button">Eliminar</button>
          </div>
          <div class="admin-list" id="brandList" style="margin-top:10px"></div>
        </div>

        <div class="field" style="margin-top:14px">
          <label>Modelo</label>
          <div class="admin-row">
            <input id="modelInput" class="input" placeholder="Nuevo modelo…" />
            <button class="btn" id="btnAddModel" type="button">Añadir</button>
            <button class="btn ghost danger" id="btnDelModel" type="button">Eliminar</button>
          </div>
          <div class="admin-list" id="modelList" style="margin-top:10px"></div>
        </div>
      </section>

      <section class="card" style="padding:18px">
        <div class="section-title">Versiones</div>
        <div class="small muted">Selecciona marca y modelo a la izquierda.</div>

        <div class="admin-row" style="margin-top:10px">
          <div class="field">
            <label>Nombre versión</label>
            <input id="vName" class="input" placeholder='Ej: 1.5 TSI 150cv DSG' />
          </div>
          <div class="field">
            <label>Motorización</label>
            <select id="vType" class="input">
              <option value="gasolina">Gasolina</option>
              <option value="diesel">Diésel</option>
              <option value="hibrido">Híbrido</option>
              <option value="phev">PHEV</option>
              <option value="ev">Eléctrico (EV)</option>
            </select>
          </div>
        </div>

        <div class="admin-row">
          <div class="field" id="displacementWrap">
            <label>Cilindrada (L)</label>
            <input id="vDisp" class="input" type="number" step="0.1" placeholder="Ej: 1.5" />
          </div>
          <div class="field">
            <label>Potencia (kW)</label>
            <input id="vKw" class="input" type="number" step="1" placeholder="Ej: 110" />
          </div>
          <div class="field" id="batteryWrap" style="display:none">
            <label>Batería (kWh)</label>
            <input id="vBat" class="input" type="number" step="0.1" placeholder="Ej: 77" />
          </div>
        </div>

        <div class="admin-row">
          <div class="field">
            <label>Precio desde (€)</label>
            <input id="vPriceFrom" class="input" type="number" step="50" placeholder="Ej: 29990" />
          </div>
          <div class="field">
            <label>Precio hasta (€) (opcional)</label>
            <input id="vPriceTo" class="input" type="number" step="50" placeholder="Ej: 34990" />
          </div>
          <button class="btn" id="btnAddVersion" type="button">Guardar/Upsert versión</button>
          <button class="btn ghost danger" id="btnDelVersion" type="button">Eliminar versión</button>
        </div>

        <div class="admin-list" id="versionList" style="margin-top:12px"></div>
        <div class="hint" style="margin-top:10px">
          Consejo: si guardas una versión con el mismo <b>nombre</b>, se actualiza (upsert) en vez de duplicarse.
        </div>
      </section>
    </div>
  </main>

  <script src="assets/carDatabase-v3.js"></script>
  <script src="assets/brandModels_es.js"></script>
  <script src="assets/carDatabase-patch.js"></script>
  <script src="assets/dbPatchRuntime.js"></script>

  <script>
    (function(){
      const $ = (s)=>document.querySelector(s);
      const status = $("#adminStatus");

      const api = window.FAIRCAR_DB_PATCH;
      const LS_KEY = api.LS_KEY;
      const db = window.CAR_DB;

      // Cargar patch local (solo lo local). Si no existe, crear.
      function loadLocalPatch(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          return raw ? JSON.parse(raw) : { upsert:{}, disable:{brands:[], models:{}, versions:{}} };
        }catch(e){
          return { upsert:{}, disable:{brands:[], models:{}, versions:{}} };
        }
      }
      let localPatch = loadLocalPatch();

      function saveLocalPatch(){
        localStorage.setItem(LS_KEY, JSON.stringify(localPatch));
        status.textContent = "Cambios guardados (local)";
        status.classList.remove("muted");
        setTimeout(()=>{ status.textContent = "Catálogo cargado"; status.classList.add("muted"); }, 1200);
      }

      // UI state
      let selectedBrand = "";
      let selectedModel = "";
      let selectedVersionName = "";

      const brandList = $("#brandList");
      const modelList = $("#modelList");
      const versionList = $("#versionList");

      function listBrands(){
        return Object.keys(db||{}).sort((a,b)=>a.localeCompare(b, 'es'));
      }

      function listModels(brand){
        const b = db && db[brand];
        const m = b && b.models ? Object.keys(b.models) : [];
        return m.sort((a,b)=>a.localeCompare(b, 'es'));
      }

      function listVersions(brand, model){
        const m = db && db[brand] && db[brand].models && db[brand].models[model];
        const v = m && Array.isArray(m.versions) ? m.versions : [];
        return v.slice().sort((a,b)=>String(a.name).localeCompare(String(b.name),'es'));
      }

      function renderBrands(){
        const q = ($("#brandSearch").value||"").trim().toLowerCase();
        const brands = listBrands().filter(b=>!q || b.toLowerCase().includes(q));
        brandList.innerHTML = brands.map(b=>{
          const active = b===selectedBrand ? "style=\"background:rgba(45,212,191,.08)\"" : "";
          return `<div class="row" ${active} data-brand="${b}">${b}</div>`;
        }).join("") || `<div class="small muted">Sin marcas</div>`;
        [...brandList.querySelectorAll('[data-brand]')].forEach(el=>{
          el.style.cursor = "pointer";
          el.onclick = ()=>{ selectedBrand = el.dataset.brand; selectedModel=""; selectedVersionName=""; renderAll(); };
        });
      }

      function renderModels(){
        if(!selectedBrand){
          modelList.innerHTML = `<div class="small muted">Selecciona una marca</div>`;
          return;
        }
        const models = listModels(selectedBrand);
        modelList.innerHTML = models.map(m=>{
          const active = m===selectedModel ? "style=\"background:rgba(11,95,255,.08)\"" : "";
          return `<div class="row" ${active} data-model="${m}">${m}</div>`;
        }).join("") || `<div class="small muted">Sin modelos</div>`;
        [...modelList.querySelectorAll('[data-model]')].forEach(el=>{
          el.style.cursor = "pointer";
          el.onclick = ()=>{ selectedModel = el.dataset.model; selectedVersionName=""; renderAll(); };
        });
      }

      function renderVersions(){
        if(!selectedBrand || !selectedModel){
          versionList.innerHTML = `<div class="small muted">Selecciona marca y modelo</div>`;
          return;
        }
        const versions = listVersions(selectedBrand, selectedModel);
        versionList.innerHTML = versions.map(v=>{
          const active = String(v.name)===selectedVersionName ? "style=\"background:rgba(148,163,184,.12)\"" : "";
          const price = Array.isArray(v.priceRange) ? ` · desde ${v.priceRange[0]}€` : "";
          return `<div class="row" ${active} data-vname="${String(v.name).replace(/\"/g,'&quot;')}"><b>${v.name}</b><span class="small muted">${price}</span></div>`;
        }).join("") || `<div class="small muted">Sin versiones</div>`;
        [...versionList.querySelectorAll('[data-vname]')].forEach(el=>{
          el.style.cursor = "pointer";
          el.onclick = ()=>{
            selectedVersionName = el.dataset.vname;
            // cargar en formulario
            const v = listVersions(selectedBrand, selectedModel).find(x=>String(x.name)===selectedVersionName);
            if(v){
              $("#vName").value = v.name||"";
              $("#vType").value = v.type||"gasolina";
              $("#vDisp").value = (v.displacement!=null? v.displacement : "");
              $("#vKw").value = (v.power_kw!=null? v.power_kw : "");
              $("#vBat").value = (v.battery_kwh!=null? v.battery_kwh : "");
              if(Array.isArray(v.priceRange)){
                $("#vPriceFrom").value = v.priceRange[0]||"";
                $("#vPriceTo").value = v.priceRange[1]||"";
              }
              updateTypeVisibility();
            }
            renderAll();
          };
        });
      }

      function updateTypeVisibility(){
        const t = $("#vType").value;
        const isEv = t==="ev";
        const isPhev = t==="phev";
        $("#batteryWrap").style.display = (isEv || isPhev) ? "block" : "none";
        $("#displacementWrap").style.display = (isEv) ? "none" : "block";
      }

      $("#vType").addEventListener("change", updateTypeVisibility);
      updateTypeVisibility();

      function renderAll(){
        renderBrands();
        renderModels();
        renderVersions();
      }

      // -------- Patch helpers --------
      function ensurePatchBrand(brand){
        if(!localPatch.upsert) localPatch.upsert = {};
        if(!localPatch.upsert[brand]) localPatch.upsert[brand] = { brand_info:{}, models:{} };
        if(!localPatch.upsert[brand].models) localPatch.upsert[brand].models = {};
      }
      function unDisableBrand(brand){
        const arr = localPatch.disable && localPatch.disable.brands ? localPatch.disable.brands : [];
        localPatch.disable.brands = arr.filter(b=>b!==brand);
      }
      function unDisableModel(brand, model){
        localPatch.disable.models = localPatch.disable.models || {};
        const arr = localPatch.disable.models[brand] || [];
        localPatch.disable.models[brand] = arr.filter(m=>m!==model);
      }
      function unDisableVersion(brand, model, name){
        localPatch.disable.versions = localPatch.disable.versions || {};
        localPatch.disable.versions[brand] = localPatch.disable.versions[brand] || {};
        const arr = localPatch.disable.versions[brand][model] || [];
        localPatch.disable.versions[brand][model] = arr.filter(x=>x!==name);
      }

      // -------- Actions --------
      $("#btnAddBrand").onclick = ()=>{
        const brand = ($("#brandSearch").value||"").trim();
        if(!brand) return alert("Escribe una marca");
        ensurePatchBrand(brand);
        unDisableBrand(brand);
        // materializar en DB runtime
        if(!db[brand]) db[brand] = { brand_info:{}, models:{} };
        selectedBrand = brand;
        selectedModel = "";
        saveLocalPatch();
        renderAll();
      };

      $("#btnDelBrand").onclick = ()=>{
        if(!selectedBrand) return alert("Selecciona una marca");
        if(!confirm(`Eliminar (ocultar) la marca "${selectedBrand}"?`)) return;
        localPatch.disable = localPatch.disable || {brands:[], models:{}, versions:{}};
        localPatch.disable.brands = localPatch.disable.brands || [];
        if(!localPatch.disable.brands.includes(selectedBrand)) localPatch.disable.brands.push(selectedBrand);
        if(localPatch.upsert) delete localPatch.upsert[selectedBrand];
        // aplicar
        if(db[selectedBrand]) delete db[selectedBrand];
        selectedBrand=""; selectedModel=""; selectedVersionName="";
        saveLocalPatch();
        renderAll();
      };

      $("#btnAddModel").onclick = ()=>{
        if(!selectedBrand) return alert("Selecciona una marca");
        const model = ($("#modelInput").value||"").trim();
        if(!model) return alert("Escribe un modelo");
        ensurePatchBrand(selectedBrand);
        localPatch.upsert[selectedBrand].models[model] = localPatch.upsert[selectedBrand].models[model] || { versions: [] };
        unDisableModel(selectedBrand, model);
        // materializar
        db[selectedBrand] = db[selectedBrand] || { brand_info:{}, models:{} };
        db[selectedBrand].models = db[selectedBrand].models || {};
        db[selectedBrand].models[model] = db[selectedBrand].models[model] || { versions: [] };
        selectedModel = model;
        $("#modelInput").value = "";
        saveLocalPatch();
        renderAll();
      };

      $("#btnDelModel").onclick = ()=>{
        if(!selectedBrand || !selectedModel) return alert("Selecciona marca y modelo");
        if(!confirm(`Eliminar (ocultar) el modelo "${selectedModel}" de ${selectedBrand}?`)) return;
        localPatch.disable = localPatch.disable || {brands:[], models:{}, versions:{}};
        localPatch.disable.models = localPatch.disable.models || {};
        localPatch.disable.models[selectedBrand] = localPatch.disable.models[selectedBrand] || [];
        if(!localPatch.disable.models[selectedBrand].includes(selectedModel)) localPatch.disable.models[selectedBrand].push(selectedModel);
        if(localPatch.upsert && localPatch.upsert[selectedBrand] && localPatch.upsert[selectedBrand].models){
          delete localPatch.upsert[selectedBrand].models[selectedModel];
        }
        if(db[selectedBrand] && db[selectedBrand].models) delete db[selectedBrand].models[selectedModel];
        selectedModel=""; selectedVersionName="";
        saveLocalPatch();
        renderAll();
      };

      function kwToCv(kw){
        const n = Number(kw);
        if(!isFinite(n) || n<=0) return null;
        return Math.round(n * 1.35962);
      }

      $("#btnAddVersion").onclick = ()=>{
        if(!selectedBrand || !selectedModel) return alert("Selecciona marca y modelo");
        const name = ($("#vName").value||"").trim();
        if(!name) return alert("Escribe el nombre de la versión");
        const type = $("#vType").value;
        const kw = Number($("#vKw").value||0);
        const cv = kwToCv(kw);
        const dispRaw = $("#vDisp").value;
        const disp = dispRaw!=="" ? String(dispRaw) : null;
        const batRaw = $("#vBat").value;
        const bat = batRaw!=="" ? Number(batRaw) : null;
        const pFrom = Number($("#vPriceFrom").value||0);
        const pTo = Number($("#vPriceTo").value||0);
        const priceRange = pFrom>0 ? [pFrom, (pTo>0 ? pTo : Math.round(pFrom*1.1))] : null;

        const v = {
          name,
          type,
          displacement: (type==="ev") ? null : (disp||null),
          power_kw: (kw>0? kw : null),
          power_cv: (cv||null),
          battery_kwh: ((type==="ev" || type==="phev") ? (bat||null) : null),
          priceRange: (priceRange||undefined)
        };

        ensurePatchBrand(selectedBrand);
        localPatch.upsert[selectedBrand].models[selectedModel] = localPatch.upsert[selectedBrand].models[selectedModel] || { versions: [] };
        localPatch.upsert[selectedBrand].models[selectedModel].versions = localPatch.upsert[selectedBrand].models[selectedModel].versions || [];
        // upsert by name
        const arr = localPatch.upsert[selectedBrand].models[selectedModel].versions;
        const idx = arr.findIndex(x=>String(x.name)===name);
        if(idx>=0) arr[idx] = Object.assign({}, arr[idx], v);
        else arr.push(v);
        unDisableVersion(selectedBrand, selectedModel, name);

        // materializar runtime en DB
        db[selectedBrand] = db[selectedBrand] || { brand_info:{}, models:{} };
        db[selectedBrand].models = db[selectedBrand].models || {};
        db[selectedBrand].models[selectedModel] = db[selectedBrand].models[selectedModel] || { versions: [] };
        db[selectedBrand].models[selectedModel].versions = db[selectedBrand].models[selectedModel].versions || [];
        const idx2 = db[selectedBrand].models[selectedModel].versions.findIndex(x=>String(x.name)===name);
        if(idx2>=0) db[selectedBrand].models[selectedModel].versions[idx2] = Object.assign({}, db[selectedBrand].models[selectedModel].versions[idx2], v);
        else db[selectedBrand].models[selectedModel].versions.push(v);

        selectedVersionName = name;
        saveLocalPatch();
        renderAll();
      };

      $("#btnDelVersion").onclick = ()=>{
        if(!selectedBrand || !selectedModel) return alert("Selecciona marca y modelo");
        const name = ($("#vName").value||selectedVersionName||"").trim();
        if(!name) return alert("Selecciona o escribe el nombre de la versión");
        if(!confirm(`Eliminar (ocultar) la versión "${name}"?`)) return;
        localPatch.disable = localPatch.disable || {brands:[], models:{}, versions:{}};
        localPatch.disable.versions = localPatch.disable.versions || {};
        localPatch.disable.versions[selectedBrand] = localPatch.disable.versions[selectedBrand] || {};
        localPatch.disable.versions[selectedBrand][selectedModel] = localPatch.disable.versions[selectedBrand][selectedModel] || [];
        if(!localPatch.disable.versions[selectedBrand][selectedModel].includes(name)) localPatch.disable.versions[selectedBrand][selectedModel].push(name);
        // quitar de upsert
        const arr = localPatch.upsert?.[selectedBrand]?.models?.[selectedModel]?.versions;
        if(Array.isArray(arr)) localPatch.upsert[selectedBrand].models[selectedModel].versions = arr.filter(v=>String(v.name)!==name);
        // materializar runtime
        const vArr = db?.[selectedBrand]?.models?.[selectedModel]?.versions;
        if(Array.isArray(vArr)) db[selectedBrand].models[selectedModel].versions = vArr.filter(v=>String(v.name)!==name);
        selectedVersionName = "";
        saveLocalPatch();
        renderAll();
      };

      // Export / Import / Reset
      $("#btnExport").onclick = ()=>{
        const filePatch = api.loadJsonSync("assets/faircar_db_patch.json") || { upsert:{}, disable:{brands:[], models:{}, versions:{}} };
        const merged = api.mergePatches(filePatch, localPatch);
        const blob = new Blob([JSON.stringify(merged, null, 2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "faircar_db_patch.json";
        a.click();
        URL.revokeObjectURL(a.href);
      };

      $("#fileImport").addEventListener("change", async (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const text = await file.text();
        try{
          localPatch = JSON.parse(text);
          saveLocalPatch();
          // recargar para aplicar limpio
          location.reload();
        }catch(err){
          alert("JSON inválido");
        }
      });

      $("#btnResetLocal").onclick = ()=>{
        if(!confirm("Borrar los cambios locales (localStorage) del admin?")) return;
        localStorage.removeItem(LS_KEY);
        location.reload();
      };

      $("#brandSearch").addEventListener("input", renderBrands);

      renderAll();
    })();
  </script>
  <script src="assets/theme.js"></script>
</body>
</html>
